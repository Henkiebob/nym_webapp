<link rel="import" href="../core-animated-pages/core-animated-pages.html">
<link rel="import" href="../core-animated-pages/transitions/slide-from-right.html">
<link rel="import" href="../core-icons/core-icons.html">
<link rel="import" href="../core-animation/core-animation.html">
<link rel="import" href="../core-collapse/core-collapse.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">

<link rel="import" href="single-task.html">
<link rel="import" href="single-task-open.html">
<link rel="import" href="single-task-group.html">
<link rel="import" href="single-task-done.html">

<polymer-element name="tasks-view" attributes="start">
	<template>
		<style>
			*{
				margin:0;
				padding:0;
				box-sizing:border-box;
				-webkit-backface-visibility:hidden;
			}

			#wrapper{
				height:calc(100vh - 80px);
				width:100%;
				overflow-y:auto;
				overflow-x:hidden;
				background:#F8F8F8;
				-webkit-overflow-scrolling:touch;
				-webkit-user-select: none;
        		-webkit-tap-highlight-color: rgba(0,0,0,0);
			}

			header{
				width:100%;
				height:290px;
				background:#DC5957;
				text-align:center;
				padding:30px 0;
				color:white;
				margin-bottom:20px;
				position:relative;
			}

			header h1{
				color:white;
				font-size:20px;
				text-transform:capitalize;
			}

			header .photos{
				position:relative;
				width:130px;
				height:130px;
				margin:20px auto 30px;
				transform-style:preserve-3d;
			}

			header .photos .img{
				position:absolute;
				left:0;
				top:0;
				width:130px;
				height:130px;
				border-radius:75px;
				border:2px solid white;
				backface-visibility:hidden;
				background-size:cover;
				background-position:center;
				background-repeat:no-repeat;
			}

			header paper-tabs{
				height:40px;
				padding:0 20px;
			}

			header paper-tabs::shadow #selectionBar{
				background-color:#FFF;
			}

			header paper-tabs core-icon{
				width:18px;
			}

			.content{
				background:#FFF;
			}

			.content h2{
				text-align:center;
				font-size:16px;
				line-height:40px;
				border-bottom:2px solid #C7C7C7;
				margin-bottom:15px;
			}

			.content .tasks{
				overflow:hidden;
			}

			paper-tabs#navigation, core-toolbar{
				position:fixed;
				left:0;
				bottom:0;
				height:80px;
				width:100%;
				background:#DC5957;
				color:#FFF;
				box-shadow:0px 3px 2px rgba(0, 0, 0, 0.2);
			}

			paper-tabs#navigation::shadow #selectionBar{
				background-color:#B32F2D;
				display:none;
			}

			paper-tabs paper-tab::shadow #ink{
				color:rgba(255,255,255,0.3);
			}

      .logout{
        top:0px;
        height:10px;
        width:10px;
        font-size:11px;
        right:20px;
        position: absolute;
      }
		</style>

		<core-ajax id="ajaxGetTasks"
			auto="false"
			url="http://178.62.205.200/api/tasks"
			on-core-response="{{tasksLoaded}}"
			handleAs="json"
			method="GET">
		</core-ajax>

		<core-ajax id="ajaxUpdateTask"
			auto="false"
			on-core-response="{{taskUpdated}}"
			method="PUT">
		</core-ajax>

		<div id="wrapper">
			<header>
				<h1>{{username}}</h1> <paper-button class="logout" on-tap="{{logout}}">Uitloggen</paper-button>

				<div class="photos">
					<div class="img single" style="background-image:url({{avatar}})"></div>
					<!--<div class="img group" style="background-image:url()"></div>-->
				</div>

				<paper-tabs selected="0" noink="true">
					<paper-tab on-tap="{{headerToTodo}}"><core-icon icon="subject"></core-icon> {{header_todo}} taken</paper-tab>
					<paper-tab on-tap="{{headerToDone}}"><core-icon icon="done-all"></core-icon> {{header_done}} afgerond</paper-tab>
					<paper-tab on-tap="{{headerToPoints}}"><core-icon icon="trending-up"></core-icon> {{header_points}} punten</paper-tab>
				</paper-tabs>
			</header>

			<div class="content">
				<core-animated-pages id="pages" selected="0" transitions="slide-from-right">
					<div>
						<core-collapse id="tasks_todo" class="tasks">
							<h2>Wat moet ik nog gaan doen?</h2>

							<template repeat="{{task, taskIndex in tasks}}">
								<single-task name="{{task.name}}" duration="{{task.duration}}" deadline="{{task.deadline}}" points={{task.points}} task_position="{{taskIndex}}" task_id="{{task.id}}" on-finish-task="{{finishTask}}"></single-task>
							</template>
						</core-collapse>

						<core-collapse id="tasks_group" class="tasks tasks-group">
							<h2>Wat wordt door de groep gedaan?</h2>

							<template repeat="{{task in tasks_group}}">
								<single-task-group name="{{task.name}}" deadline="{{task.deadline}}" points={{task.points}} avatar="{{task.avatar}}"></single-task-group>
							</template>
						</core-collapse>

						<section id="tasks_open" class="tasks">
							<h2>Wat kan ik nog gaan doen?</h2>

							<template repeat="{{task, taskIndex in tasks_open}}">
								<single-task-open name="{{task.name}}" deadline="{{task.deadline}}" points={{task.points}} task_position="{{taskIndex}}" task_id="{{task.id}}" on-pick-task="{{pickTask}}"></single-task>
							</template>
						</section>
					</div>
					<div>
						<core-collapse id="tasks_done" class="tasks">
							<h2>Wat ik al gedaan heb</h2>

							<template repeat="{{task in tasks_done}}">
								<single-task-done name="{{task.name}}" deadline="{{task.deadline}}" points={{task.points}}></single-task-done>
							</template>
						</core-collapse>

						<core-collapse id="tasks_group_done" class="tasks tasks-group">
							<h2>Wat de groep al gedaan heeft</h2>

							<template repeat="{{task in tasks_group_done}}">
								<single-task-group name="{{task.name}}" deadline="{{task.deadline}}" points={{task.points}} avatar="{{task.avatar}}" done="done"></single-task-group>
							</template>
						</core-collapse>
					</div>
					<div>
						Points
					</div>
				</core-animated-pages>
			</div>
		</div>

		<paper-tabs selected="0" noink="true" id="navigation">
			<paper-tab on-tap="{{showSingle}}">Single</paper-tab>
			<paper-tab on-tap="{{showGroup}}">Group</paper-tab>
			<paper-tab on-tap="{{gotoSettings}}">Settings</paper-tab>
		</paper-tabs>
	</template>

	<script>
		Polymer({
			ready:function(){
			//	this.startChanged();
			//},
			//startChanged:function(oldValue, newValue){
        		//if(newValue == 'true'){
					this.users = JSON.parse(localStorage.users);
					this.username = this.users[localStorage.user_id].name;
					this.avatar = 'http://178.62.205.200'+this.users[localStorage.user_id].avatar;

					var auth = {'Authorization': 'Token token='+localStorage.token};
					this.$.ajaxGetTasks.headers = auth;
					this.$.ajaxUpdateTask.headers = auth;

					this.$.ajaxGetTasks.params = {'house_id':localStorage.house_id};
					this.$.ajaxGetTasks.go();

					this.$.tasks_todo.opened = true;
					this.$.tasks_done.opened = true;
				//}
			},
			tasksLoaded:function(){
				var tasks = this.$.ajaxGetTasks.response.slice(0);

				this.tasks = [];
				this.tasks_done = [];

				this.tasks_open = [];

				this.tasks_group = [];
				this.tasks_group_done = [];

				this.header_todo = 0;
				this.header_done = 0;

				for(var i = 0; i < tasks.length; i++){
					var task = tasks[i];
					if(task.status != 1){ //Unfinished Tasks
						if(task.user_id == localStorage.user_id){ //Task picked-up by user
							this.tasks.push(task);
							this.header_todo++;
						}else if(task.user_id == null){ //Open task
							this.tasks_open.push(task);
						}else{ //Task picked-up by groupmember
							this.tasks_group.push(task);
							task.avatar = this.users[task.user_id].avatar;
						}
					}else if(task.status == 1){ //Finished Tasks
						if(task.user_id == localStorage.user_id){ //Task done by user
							this.tasks_done.push(task);
							this.header_done++;
						}else{ //Task done by groupmember
							this.tasks_group_done.push(task);
							task.avatar = this.users[task.user_id].avatar;
						}
					}

					//console.log('id: '+task.id+', name: '+task.name+', user: '+task.user_id+', status: '+task.status+', points: '+task.points);
				}
			},
			pickTask:function(event, detail, sender){
				var task = this.tasks_open[detail.task_pos];
				this.tasks.push(task);
				this.tasks_open.splice(detail.task_pos, 1);
				this.header_todo++;

				//update database
				this.$.ajaxUpdateTask.url = 'http://178.62.205.200/api/tasks/'+detail.task_id;
				this.$.ajaxUpdateTask.params = {'task[user_id]':localStorage.user_id};
				this.$.ajaxUpdateTask.go();
			},
			finishTask:function(event, detail, sender){
				var task = this.tasks[detail.task_pos];

                if(detail.task_id == task.id){
                    //duplicate to done list
                    var task_done = (JSON.parse(JSON.stringify(task)));
                    task_done.deadline = new Date;
                    this.tasks_done.push(task_done);

                    //remove from todo list
				    this.tasks.splice(detail.task_pos, 1);

                    //add to open list
                    this.tasks_open.push(task);

                    //update header
                    this.header_todo--;
                    this.header_done++;

                    //set new deadline
                    if(!task.duration) task.duration = 7;
                    var date = new Date;
                    var next = date.setDate(date.getDate() + task.duration);

                    var deadline = new Date(next),
                        day = deadline.getDate(),
                        month = deadline.getMonth(),
                        months = ["januari","februari","maart","april","mei","juni","juli", "augustus","september","oktober","november","december"];

                    task.deadline = day+' '+months[month];

                    //update database
                    this.$.ajaxUpdateTask.url = 'http://178.62.205.200/api/tasks/'+detail.task_id;
                    //this.$.ajaxUpdateTask.params = {'task[status]':1};
                    this.$.ajaxUpdateTask.params = {'task[deadline]':new Date(next), 'task[user]':''};
                    //this.$.ajaxUpdateTask.go();
                }
			},
			taskUpdated:function(event, detail, sender){
				//console.log()
			},
			headerToTodo:function(event, detail, sender){
				sender.classList.add('active');
				this.$.pages.selected = 0;
			},
			headerToDone:function(event, detail, sender){
				sender.classList.add('active');
				this.$.pages.selected = 1;
			},
			headerToPoints:function(){
				this.$.pages.selected = 2;
			},
			showSingle:function(){
				this.$.tasks_todo.opened = true;
				this.$.tasks_done.opened = true;

				this.$.tasks_group.opened = false;
				this.$.tasks_group_done.opened = false;

				this.header_todo = this.tasks.length;
				this.header_done = this.tasks_done.length;
			},
			showGroup:function(){
				this.$.tasks_group.opened = true;
				this.$.tasks_group_done.opened = true;

				this.$.tasks_todo.opened = false;
				this.$.tasks_done.opened = false;

				this.header_todo = this.tasks_group.length;
				this.header_done = this.tasks_group_done.length;
			},
			gotoSettings:function(){
				this.fire('go-to', {page:'settings-view'});
			},
      logout:function(){
        localStorage.clear();
        location.reload();
      }
		});
	</script>
</polymer-element>
